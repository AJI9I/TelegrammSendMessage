# Техническая спецификация проекта TeggammMessage

## 1. Обзор системы

### 1.1 Назначение
Программа для автоматической рассылки сообщений в группы Telegram с поддержкой автоматического вступления в группы из файла.

### 1.2 Целевая платформа
- Операционная система: Windows, Linux, macOS
- Python: 3.8 или выше
- Запуск: без установки (portable) или простая установка

## 2. Архитектура системы

### 2.1 Компоненты системы

```
┌─────────────────────────────────────────┐
│         Пользовательский интерфейс      │
│  (GUI или CLI)                          │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Менеджер приложения                │
│  - Координация компонентов              │
│  - Управление состоянием                │
└──────────────┬──────────────────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
┌───▼──────────┐   ┌──────▼──────────┐
│ Telegram     │   │ Менеджер групп  │
│ Client       │   │                 │
│              │   │ - Парсинг файла │
│ - Авторизация│   │ - Валидация     │
│ - Сессия     │   │ - Вступление    │
└───┬──────────┘   └──────┬──────────┘
    │                     │
    └──────────┬──────────┘
               │
    ┌──────────▼──────────┐
    │  Отправитель        │
    │  сообщений          │
    │  - Рассылка         │
    │  - Задержки         │
    │  - Логирование      │
    └──────────┬──────────┘
               │
    ┌──────────▼──────────┐
    │  Планировщик        │
    │  - Интервалы        │
    │  - Расписание       │
    │  - Управление       │
    └─────────────────────┘
```

### 2.2 Основные модули

#### 2.2.1 Telegram Client (`telegram_client.py`)
**Ответственность:**
- Установка соединения с Telegram API
- Авторизация пользователя
- Управление сессией
- Получение информации о диалогах
- Проверка участия в группах
- Вступление в группы
- Отправка сообщений

**Основные методы:**
```python
class TelegramClient:
    async def connect() -> bool
    async def authenticate() -> bool
    async def get_dialogs() -> List[Dialog]
    async def is_member(group_username: str) -> bool
    async def join_group(group_username: str) -> bool
    async def send_message(group_username: str, message: str) -> bool
    async def disconnect()
```

#### 2.2.2 Group Manager (`group_manager.py`)
**Ответственность:**
- Парсинг файла с адресами групп
- Валидация адресов
- Управление списком выбранных групп
- Фильтрация групп

**Основные методы:**
```python
class GroupManager:
    def load_from_file(filepath: str) -> List[str]
    def parse_group_address(address: str) -> str
    def validate_address(address: str) -> bool
    def filter_duplicates(groups: List[str]) -> List[str]
```

#### 2.2.3 Message Sender (`message_sender.py`)
**Ответственность:**
- Координация процесса рассылки
- Управление задержками
- Обработка ошибок
- Логирование результатов

**Основные методы:**
```python
class MessageSender:
    async def send_to_groups(groups: List[str], message: str) -> Dict
    async def join_groups_if_needed(groups: List[str]) -> Dict
    def get_progress() -> float
    def get_status() -> str
```

#### 2.2.4 Delay Manager (`delay_manager.py`)
**Ответственность:**
- Генерация задержек с случайными вариациями
- Управление таймингами операций

**Основные методы:**
```python
class DelayManager:
    def get_join_delay() -> float
    def get_send_delay() -> float
    def random_delay(min_sec: float, max_sec: float) -> float
```

#### 2.2.5 File Parser (`file_parser.py`)
**Ответственность:**
- Чтение файла с адресами групп
- Парсинг различных форматов адресов
- Очистка данных

**Основные методы:**
```python
class FileParser:
    def parse_file(filepath: str) -> List[str]
    def normalize_address(address: str) -> str
    def extract_username(link: str) -> str
```

#### 2.2.6 Scheduler (`scheduler.py`)
**Ответственность:**
- Планирование рассылок по расписанию
- Управление интервальными рассылками
- Управление рассылками по конкретным временам
- Отслеживание следующей запланированной рассылки

**Основные методы:**
```python
class Scheduler:
    def start() -> None
    def stop() -> None
    def set_interval_mode(hours: int) -> None
    def set_schedule_mode(times: List[str]) -> None
    def set_immediate_mode() -> None
    def get_next_run_time() -> datetime | None
    def is_enabled() -> bool
    async def run_scheduled_task() -> None
```

## 3. Детальная спецификация функций

### 3.1 Авторизация в Telegram

**Процесс:**
1. Запрос API ID и API Hash (если не сохранены)
2. Создание клиента Telethon/Pyrogram
3. Проверка существования сессии
4. Если сессия есть - загрузка и проверка
5. Если сессии нет - запрос номера телефона
6. Запрос кода подтверждения
7. Ввод кода (и пароля 2FA, если требуется)
8. Сохранение сессии

**Обработка ошибок:**
- Неверный номер телефона
- Неверный код подтверждения
- Требуется 2FA
- Сетевая ошибка
- Flood wait (слишком много запросов)

### 3.2 Загрузка групп из файла

**Формат файла:**
- Текстовый файл (.txt)
- Одна группа на строку
- Поддерживаемые форматы:
  - `@username`
  - `https://t.me/username`
  - `t.me/username`
  - `https://t.me/joinchat/xxxxx` (invite links)

**Процесс:**
1. Открытие файла
2. Чтение строк
3. Парсинг каждой строки
4. Нормализация адресов
5. Валидация формата
6. Удаление дубликатов
7. Возврат списка групп

**Обработка ошибок:**
- Файл не найден
- Неверный формат адреса
- Пустые строки
- Специальные символы

### 3.3 Автоматическое вступление в группы

**Процесс:**
1. Для каждой группы из списка:
   - Проверка участия пользователя
   - Если не состоит:
     - Попытка вступления
     - Ожидание задержки (случайная, 5-15 сек)
   - Логирование результата
2. Обработка ошибок для каждой группы

**Обработка ошибок:**
- Группа не найдена
- Группа приватная (требуется invite)
- Пользователь уже забанен
- Flood wait
- Недостаточно прав

### 3.4 Рассылка сообщений

**Процесс:**
1. Получение текста сообщения из интерфейса
2. Подготовка сообщения
3. Для каждой группы:
   - Проверка участия (если не проверялось ранее)
   - Отправка сообщения
   - Ожидание задержки (случайная, 3-10 сек)
   - Логирование результата
4. Формирование отчета

**Редактирование сообщения:**
- Многострочное текстовое поле в интерфейсе
- Возможность сохранения шаблонов
- Валидация длины сообщения
- Поддержка форматирования (Markdown, HTML - опционально)

**Обработка ошибок:**
- Группа не найдена
- Пользователь не состоит в группе
- Недостаточно прав для отправки
- Сообщение слишком длинное
- Flood wait
- Группа удалена/заблокирована

### 3.5 Планировщик рассылок

**Режимы работы:**

1. **Немедленная рассылка (immediate):**
   - Отправка сразу после нажатия кнопки
   - Однократная рассылка

2. **Интервальная рассылка (interval):**
   - Рассылка через заданный интервал (например, раз в 3 часа)
   - Начало отсчета от момента последней рассылки
   - Работает в фоновом режиме

3. **Рассылка по расписанию (schedule):**
   - Рассылка в заданные времена (например: 9:00, 12:00, 14:00, 19:00)
   - Поддержка множественных времен в день
   - Учет часового пояса

**Процесс:**
1. Пользователь выбирает режим планировщика
2. Настраивает параметры (интервал или времена)
3. Включает планировщик
4. Планировщик отслеживает время и запускает рассылку
5. После каждой рассылки планируется следующая

**Настройки:**
- Часовой пояс (по умолчанию системный, можно выбрать из списка)
- Список времен для режима schedule (формат: "HH:MM" или "H:MM", через запятую)
- Интервал для режима interval (в часах, целое число)
- Включение/выключение планировщика

**Формат времени для режима schedule:**
- Поддерживаемые форматы:
  - `"9"` или `"09"` → 09:00
  - `"9:00"` или `"09:00"` → 09:00
  - `"12:30"` → 12:30
  - `"19"` → 19:00
- Ввод через запятую: `"9,12,14,19"` или `"9:00,12:00,14:00,19:00"`
- Валидация: проверка корректности формата и диапазона (00:00 - 23:59)

**Примеры использования:**

1. **Интервальная рассылка (раз в 3 часа):**
   - Режим: `interval`
   - Интервал: `3` часа
   - Первая рассылка: сразу после включения
   - Следующие: каждые 3 часа после предыдущей

2. **Рассылка по расписанию (каждый день в 9, 12, 14, 19):**
   - Режим: `schedule`
   - Времена: `"9,12,14,19"` или `"9:00,12:00,14:00,19:00"`
   - Часовой пояс: `Europe/Moscow` (или другой)
   - Рассылка будет происходить каждый день в указанные времена

**Обработка ошибок:**
- Неверный формат времени (показ сообщения с примером)
- Планировщик не запущен (предупреждение при попытке включить)
- Ошибка при выполнении запланированной задачи (логирование, продолжение работы)
- Перезапуск планировщика при сбое

### 3.6 Система задержек

**Типы задержек:**
1. **Задержка при вступлении в группы:**
   - Минимум: 5 секунд
   - Максимум: 15 секунд
   - Случайное значение между min и max

2. **Задержка при отправке сообщений:**
   - Минимум: 3 секунды
   - Максимум: 10 секунд
   - Случайное значение между min и max

**Реализация:**
- Использование `random.uniform(min, max)`
- Асинхронное ожидание `asyncio.sleep()`
- Возможность настройки через конфиг

## 4. Пользовательский интерфейс

### 4.1 Главное окно

**Элементы:**
- Кнопка "Авторизация" / Статус авторизации
- **Многострочное текстовое поле для редактирования сообщения**
  - Поддержка многострочного текста
  - Счетчик символов
  - Кнопка "Сохранить шаблон" (опционально)
  - Кнопка "Загрузить шаблон" (опционально)
- Кнопка "Выбрать группы вручную"
- Кнопка "Загрузить из файла"
- Список выбранных групп
- **Панель планировщика:**
  - Переключатель режима: "Немедленно" / "Интервал" / "Расписание"
  - Для режима "Интервал": поле "Каждые N часов"
  - Для режима "Расписание": поле "Времена (через запятую): 9,12,14,19"
  - Выбор часового пояса
  - Кнопка "Включить планировщик" / "Выключить планировщик"
  - Отображение: "Следующая рассылка: [дата и время]"
- Кнопка "Начать рассылку" (для немедленного режима)
- Прогресс-бар
- Область логов
- Кнопка "Настройки"

### 4.2 Окно авторизации

**Элементы:**
- Поле для API ID
- Поле для API Hash
- Кнопка "Получить на my.telegram.org"
- Поле для номера телефона
- Поле для кода подтверждения
- Поле для пароля 2FA (если требуется)
- Кнопка "Войти"
- Статус авторизации

### 4.3 Окно настроек

**Элементы:**
- Задержка при вступлении (min/max)
- Задержка при отправке (min/max)
- Путь к файлу сессии
- Включить/выключить логирование
- Уровень логирования
- Настройки планировщика (часовой пояс по умолчанию)

## 5. Структура данных

### 5.1 Конфигурация
```python
{
    "telegram": {
        "api_id": str,
        "api_hash": str,
        "session_file": str
    },
    "delays": {
        "join_group_min": float,
        "join_group_max": float,
        "send_message_min": float,
        "send_message_max": float
    },
    "scheduler": {
        "enabled": bool,
        "mode": str,  # "immediate", "interval", "schedule"
        "interval_hours": int,
        "schedule_times": List[str],  # ["9:00", "12:00", "14:00", "19:00"]
        "timezone": str
    },
    "message": {
        "text": str,
        "templates": List[str]  # Список сохраненных шаблонов
    },
    "ui": {
        "theme": str,
        "language": str
    }
}
```

### 5.2 Группа
```python
{
    "address": str,        # @username или ссылка
    "username": str,       # Извлеченный username
    "is_member": bool,     # Состоит ли пользователь
    "status": str          # "pending", "joined", "error"
}
```

### 5.3 Результат операции
```python
{
    "group": str,
    "success": bool,
    "message": str,
    "error": str | None
}
```

### 5.4 Планировщик
```python
{
    "enabled": bool,
    "mode": str,  # "immediate", "interval", "schedule"
    "interval_hours": int | None,
    "schedule_times": List[str] | None,  # ["9:00", "12:00"]
    "timezone": str,
    "next_run": datetime | None
}
```

## 6. Обработка ошибок

### 6.1 Типы ошибок

1. **Ошибки авторизации:**
   - `PhoneNumberInvalidError`
   - `PhoneCodeInvalidError`
   - `PasswordHashInvalidError`
   - `SessionPasswordNeededError`

2. **Ошибки работы с группами:**
   - `GroupNotFoundError`
   - `InviteHashExpiredError`
   - `UserBannedInChannelError`
   - `FloodWaitError`

3. **Ошибки отправки:**
   - `MessageTooLongError`
   - `ChatWriteForbiddenError`
   - `UserNotParticipantError`

4. **Системные ошибки:**
   - `NetworkError`
   - `FileNotFoundError`
   - `PermissionError`

### 6.2 Стратегия обработки

- Все ошибки логируются
- Пользователю показываются понятные сообщения
- Критические ошибки останавливают процесс
- Некритические ошибки пропускаются с логированием

## 7. Логирование

### 7.1 Уровни логирования
- DEBUG - детальная информация для отладки
- INFO - общая информация о работе
- WARNING - предупреждения
- ERROR - ошибки
- CRITICAL - критические ошибки

### 7.2 Формат логов
```
[YYYY-MM-DD HH:MM:SS] [LEVEL] [MODULE] Message
```

### 7.3 Файлы логов
- `logs/app.log` - общий лог
- `logs/errors.log` - только ошибки
- Ротация логов (максимальный размер файла)

## 8. Безопасность

### 8.1 Хранение данных
- Сессия Telegram хранится локально
- API credentials в конфиге (не в коде)
- Пароли не сохраняются
- Логи не содержат чувствительных данных

### 8.2 Рекомендации
- Не коммитить сессии в git
- Не передавать сессии третьим лицам
- Использовать .gitignore для чувствительных файлов

## 9. Производительность

### 9.1 Оптимизации
- Асинхронная обработка операций
- Батчинг запросов (где возможно)
- Кэширование информации о группах
- Минимизация задержек без риска блокировки

### 9.2 Ограничения
- Учет лимитов Telegram API
- Разумные задержки для безопасности аккаунта
- Обработка FloodWait автоматически

## 10. Тестирование

### 10.1 Типы тестов
- Unit тесты для парсинга и валидации
- Integration тесты для работы с API
- E2E тесты для основных сценариев

### 10.2 Тестовые сценарии
- Авторизация с валидными данными
- Авторизация с невалидными данными
- Парсинг файла с группами
- Вступление в группу
- Отправка сообщения
- Обработка ошибок

## 11. Развертывание

### 11.1 Создание исполняемого файла
- Использование PyInstaller
- Включение всех зависимостей
- Создание одного файла (.exe для Windows)
- Тестирование на чистой системе

### 11.2 Альтернативный вариант
- requirements.txt для установки зависимостей
- Простые инструкции по запуску
- Скрипт запуска (run.bat / run.sh)

## 12. Документация

### 12.1 Необходимая документация
- README.md - общее описание и инструкции
- INSTALL.md - инструкции по установке
- USAGE.md - руководство пользователя
- API.md - документация API (если нужна)
- CHANGELOG.md - история изменений

### 12.2 Примеры
- Пример конфигурационного файла
- Пример файла с группами
- Скриншоты интерфейса

